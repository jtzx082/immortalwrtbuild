jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 新增关键步骤：源码初始化
    - name: Prepare source tree
      run: |
        # 如果使用子模块
        git submodule update --init --recursive
        
        # 或手动克隆（根据实际情况选择一种）
        # git clone https://github.com/immortalwrt/immortalwrt.git --depth=1
        
        # 确保目录存在
        mkdir -p immortalwrt

    # 修正后的配置复制步骤
    - name: Copy Configuration Files
      run: |
        test -d immortalwrt || { echo "immortalwrt directory missing!"; exit 1; }
        cp -fv .config immortalwrt/
        cp -fv feeds.conf* immortalwrt/

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file flex g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses-dev \
          libncurses5-dev libssl-dev python3 python3-dev python3-pip \
          python3-setuptools rsync unzip wget zlib1g-dev

    - name: Setup CCACHE
      run: |
        ccache -o compression=true
        ccache -M 5G
        ccache -s

    - name: Prepare Build System
      working-directory: ./immortalwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        make -j$BUILD_JOBS download

    - name: Build Firmware
      working-directory: ./immortalwrt
      run: |
        make -j$BUILD_JOBS V=s

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-bin
        path: |
          ./immortalwrt/bin/targets/x86/64/*
          ./immortalwrt/.config
