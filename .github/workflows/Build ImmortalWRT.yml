name: Build ImmortalWrt x86_64

on:
  workflow_dispatch:
  push:
    paths:
      - '.config'
      - 'feeds.conf*'

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  DL_DIR: ${{ github.workspace }}/dl
  TARGET: x86_64
  BUILD_JOBS: 4

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Swap File (8GB)
      run: |
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile

    - name: Copy Configuration Files
      run: |
        cp -fv .config immortalwrt/
        cp -fv feeds.conf.default immortalwrt/

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file flex g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses-dev \
          libncurses5-dev libssl-dev python3 python3-dev python3-pip \
          python3-setuptools rsync unzip wget zlib1g-dev

    - name: Setup CCACHE
      run: |
        ccache -o compression=true
        ccache -M 5G
        ccache -s

    - name: Prepare Build System
      working-directory: ./immortalwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        make -j$BUILD_JOBS download

    - name: Build Firmware
      working-directory: ./immortalwrt
      run: |
        make -j$BUILD_JOBS V=s

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-bin
        path: |
          ./immortalwrt/bin/targets/x86/64/*
          ./immortalwrt/.config
