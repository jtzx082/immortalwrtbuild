name: Build ImmortalWRT Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zstd

    - name: Download ImmortalWRT Image Builder
      run: |
        wget https://downloads.immortalwrt.org/releases/24.10.0/targets/x86/64/immortalwrt-imagebuilder-24.10.0-x86-64.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xf immortalwrt-imagebuilder-24.10.0-x86-64.Linux-x86_64.tar.zst
        mv immortalwrt-imagebuilder-24.10.0-x86-64.Linux-x86_64 imagebuilder

    - name: Copy .config file
      run: |
        cp .config imagebuilder/.config

    - name: Build firmware
      run: |
        cd imagebuilder
        make image PROFILE=x86-64 PACKAGES="kmod-usb-net kmod-usb-net-cdc-ether kmod-usb-net-rndis" FILES="files/"
        dd if=/dev/zero of=firmware.img bs=1M count=1024
        mkfs.ext4 -F -L "ImmortalWRT" firmware.img
        mkdir -p /mnt/firmware
        sudo mount -o loop firmware.img /mnt/firmware
        sudo cp -r bin/targets/x86/64/* /mnt/firmware/
        sudo umount /mnt/firmware

    - name: Upload firmware
      uses: actions/upload-artifact@v3.1.0
      with:
        name: immortalwrt-firmware
        path: imagebuilder/bin/targets/x86/64/
